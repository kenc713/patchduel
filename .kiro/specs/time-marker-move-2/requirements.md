# Requirements Document

## Project Description (Input)

プレイヤーは、8×8 の盤（以降タイムトラックと呼ぶ）の左上からスタートして、右回りにコマ（以降タイムマーカーと呼ぶ）を進めていく。タイムマーカーを進める数は、タイムトラック付近のパッチタイルで決める。プレイヤーは、33 枚あるパッチタイルの中から 1 枚を選び、パッチタイルに記載されている数字の分、タイムトラック上のタイムマーカーを進める。

## Requirements

### Requirement 1: 移動 — タイムマーカーの進行

**目的:** プレイヤーがパッチタイルを選択したときに、記載された数だけタイムマーカーが時計回りに移動すること。

#### 受け入れ基準

1. When プレイヤーがパッチタイルを選択したとき, the タイムトラックモジュール shall 選択されたパッチタイルに記載された数だけ、8×8 トラック上を時計回りにタイムマーカーを進める。
2. While タイムトラックモジュールがマーカー位置を更新している間, the タイムトラックモジュール shall 現在のインデックスとタイルの移動値から、新しいセルインデックスを決定論的に計算する。
3. If 選択されたパッチタイルの移動値が 0 以下である場合, then the タイムトラックモジュール shall その選択を無効としてマーカーを進めない（無効選択として扱う）。

### Requirement 2: タイル選択ルール — パッチタイルの有効性

**目的:** プレイヤーは利用可能なタイルのみ選択でき、無効な選択は検出・拒否されること。

#### 受け入れ基準

1. When プレイヤーがパッチタイルを選ぼうとしたとき, the ゲーム UI shall 現在プールに存在し利用可能なタイルのみ選択可能にする。
2. If プレイヤーが既に使用済み、もしくは存在しないタイルを選択した場合, then the ゲームロジック shall 選択を拒否し、UI は適切なエラー表示または視覚的拒否を示す。

### Requirement 3: トラックの周回（ラップ）動作

**目的:** トラックの周回（ラップ）は行わず、指定したゴールセルに到達したらゲームを終了する挙動を定義する。

#### 受け入れ基準

1. The トラック shall not wrap around; マーカーの移動はトラックの終端で停止せず、代わりにゴールセルに到達した時点でゲーム終了処理が行われる。
2. When マーカーがゴールセル `(4,3)` に到達したとき, the ゲームエンジン shall ゲームを終了状態に遷移させ、勝敗や終了ログを確定する。
3. If マーカーの移動がゴールセルを超えるステップ数を含む場合, then the タイムトラックモジュール shall マーカーをゴールセルに配置し、ゲームを終了状態に遷移する（超過分で次のラップは行わない）。
4. When ゴール到達が発生したとき, the タイムトラックモジュール shall 最終的なセルインデックスを結果位置として記録し、公開 API から照会可能にする。

### Requirement 4: 状態更新と UI 表示の整合性

**目的:** マーカー移動時にゲーム状態と UI が一貫して更新されることを保証する。

#### 受け入れ基準

1. When タイムトラックモジュールが移動を完了したとき, the ゲーム状態ストア shall プレイヤーのタイムマーカー位置を原子操作で更新し、インメモリのゲーム状態に永続化する。
2. When ゲーム状態ストアが更新されたとき, the UI shall 1 回のレンダーサイクル内で新しいマーカー位置を反映する（手動リフレッシュ不要でプレイヤーに可視化される）。
3. When マーカー移動が発生したとき, the システム shall `timeMarkerMoved` のような移動イベントを発行し、ペイロードにプレイヤー ID、元のインデックス、移動ステップ数、結果インデックスを含める。

### Requirement 5: 再現性のある API とテスト可能性

**目的:** 移動計算を外部から再現・検証でき、ユニットで検証可能にする。

#### 受け入れ基準

1. The タイムトラックモジュール shall 状態を変更せずに期待される結果インデックスを返す純粋関数 `computeNewIndex(currentIndex, steps)` を公開する。
2. When `computeNewIndex` を与えられた入力で呼び出したとき, the 関数の戻り値はゲームロジックで実際に移動を実行した場合の結果位置と一致する。
3. The モジュールは少なくとも次を検証するユニットテストを含む: 単純移動、ゴール到達（(4,3) に到達する/超過した場合の振る舞い）、無効ステップの拒否、照会が副作用を起こさないこと（冪等性）。

---

<!-- End of generated requirements (Japanese-localized) -->
