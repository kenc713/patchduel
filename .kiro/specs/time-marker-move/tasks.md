# Implementation Plan

## 1. ストア振る舞いの実装

- [x] 1.1 `placeMarker` を in-place 更新に変更し、既存マーカーの座標を更新する
  - 既存の同一プレイヤーマーカーを検出して `x,y,placedAt` を更新する実装を行う
  - 単一の `set` 呼び出しで状態を置き換えて整合性を保つ
  - _Requirements: 1.1, 1.2, 1.3_
- [x] 1.2 置換時の入力検証を追加する（座標範囲、ターン、セルの占有チェック）
  - 無効な操作は `false` を返し、状態を変更しないようにする
  - _Requirements: 3.1_
- [ ] 1.3 並列性対策を組み込み、atomic な更新を保証する
  - `set` 内での同期的更新と、競合テストのためのフックを用意する
  - _Requirements: 3.2_

## 2. セッション記録の拡張と連携

- [x] 2.1 `recordPlace` のスキーマを後方互換的に拡張する（`prevPosition?: {x,y}`, `moved?: boolean` を追加）
  - 既存呼び出しがそのまま動くことを確認する
  - _Requirements: 4.1_
- [x] 2.2 `placeMarker` から `recordPlace` を呼ぶ際に移動情報を渡すよう更新する
  - `markerId` を保持しつつ `prevPosition` と `moved: true` を渡す
  - _Requirements: 1.1, 4.1_

## 3. テスト実装

- [x] 3.1 単体テスト: `placeMarker` の基本ケース（新規、置換、無効）を実装する
  - 各ケースで `markers` の期待状態を検証する
  - _Requirements: 1.1, 1.2, 1.3, 3.1_
  - [x] 3.2 並列性テスト: 同一プレイヤーで短時間に複数 `placeMarker` 呼び出しを行うシミュレーションを追加する
  - 最終的に不変条件（プレイヤーあたり 1 マーカー）が保たれることを検証する
  - _Requirements: 3.2_
- [ ] 3.3 統合/E2E テスト: `Board` の描画が移動を反映し、古いマーカーが消えて新しいマーカーのみが表示されることを検証する（描画 200ms 要件を含む）
  - 実行環境は既存のテストセット（vitest + jsdom）で試験、必要なら Playwright を検討
  - _Requirements: 2.1_
- [x] 3.4 観測性テスト: `recordPlace` の呼び出しで `prevPosition` と `moved` が正しく記録されることを検証する
  - ログまたはセッションストアの状態を検証する
  - _Requirements: 4.1, 4.2_

## 4. 統合とレビュー

- [ ] 4.1 統合テスト実行と CI 通過確認
  - 変更を PR にまとめ、CI で全テストが通過することを確認する
  - _Requirements: 1.1, 2.1, 3.2, 4.2_
- [ ] 4.2 実装レビューと設計トレースの確認
  - 設計ファイル（`design.md`）とのトレーサビリティを確認し、必要なら設計に注記を追加する
  - _Requirements: 1.1, 1.2, 1.3, 2.1, 3.1, 3.2, 4.1, 4.2_
