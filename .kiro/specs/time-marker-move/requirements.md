# Requirements Document

## Project Description (Input)

現在の仕様では、プレイヤーがタイムマーカーを置いたとき、画面には「初期配置されたタイムマーカー」と「新たに置いたタイムマーカー」の 2 つが残る。これを変更したい。実現したいのは、マーカーの移動であるので、新たにタイムマーカーを置いたら初期位置のタイムマーカーは消えてほしい。

## Requirements

### Requirement 1: 基本移動動作

**Objective:** プレイヤーがマーカーを置き直すことで、既存のタイムマーカーが置き換えられ、盤上にそのプレイヤーのマーカーが常に最大 1 つ存在するようにする。

#### Acceptance Criteria

1. When プレイヤーが新しいタイムマーカーを盤上のセルに置く, the タイムマーカーサービス shall 既に存在する同一プレイヤーのタイムマーカーを削除し、選択した位置に新しいマーカーを配置する。
2. If プレイヤーがマーカーを既に置いておらず新規配置である, the タイムマーカーサービス shall エラーなく新しいマーカーを配置し、該当プレイヤーのマーカーが盤上に正確に 1 つ存在することを保証する。
3. The タイムマーカーサービス shall 配置後、盤上にそのプレイヤーの新しいマーカーのみが表示されていること（重複が残らない）を保証する。

### Requirement 2: 表示と UI の一貫性

**Objective:** マーカーの移動がユーザーにとって視覚的に分かりやすく一貫した挙動になるようにする。

#### Acceptance Criteria

1. When 新しいマーカーを置いた直後, the ユーザーインターフェース shall 古いマーカーの視覚表現を削除し、新しいマーカーをその位置に 200ms 以内に描画する。
2. If 描画更新に失敗した場合, the ユーザーインターフェース shall エラー状態または再試行インジケータを表示し、ゲームの一貫性を保持する（盤の内部状態は移動を反映するか、適切にロールバックされる）。

### Requirement 3: ゲーム状態とルール整合性

**Objective:** マーカー移動がゲームルール（ターン・所有権・不正配置の制約）に違反しないことを保証する。

#### Acceptance Criteria

1. When プレイヤーがマーカーを置こうとしたときにそれが相手のターンや無効なセルである場合, the タイムマーカーサービス shall 配置を拒否し、既存のマーカーを削除しない。
2. While プレイヤーの置換処理が進行中, the タイムマーカーサービス shall 並列の配置操作による競合を防止し、処理をアトミックに扱う。

### Requirement 4: テスト可能性と観測性

**Objective:** 自動テストで検証でき、デバッグのために十分なログ・状態確認が可能であること。

#### Acceptance Criteria

1. When マーカー移動が発生した場合, the タイムマーカーサービス shall 内部イベントまたは状態を通じて「以前の位置」「新しい位置」「該当プレイヤー ID」を確認可能にする。
2. The タイムマーカーサービス shall 決定論的な結果を生成する（同一入力で同一の盤状態）ため、自動化テストで検証可能である。

<!-- 要件は実装方法ではなく振る舞い（WHAT）を記述しています。 -->
